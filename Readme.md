# THU AutoWater Project

## 让水群变得智能、可扩展、易管理

---

## 📖 项目简介

THU AutoWater 是一款基于 **Napcat** 的全自动、模块化、事件驱动的 QQ 群聊机器人插件。它不仅仅是一个“水群”工具，更是一个高度可扩展、配置灵活、支持多模态 AI 响应的智能群聊助手。

项目采用 **面向模块化、事件驱动** 的设计理念，通过**统一的事件总线**、**松耦合的模块系统**、**统一的配置管理**以及**内置的持久化存储**，实现了功能的高度解耦与动态扩展，使开发者可以轻松定制和增强机器人行为，而无需深入核心逻辑。

---

## 🧠 核心设计理念

### 1. **事件驱动架构**
- 所有消息、通知、系统事件统一由 `EventHandler` 分发
- 模块通过监听事件实现功能，彼此独立，无直接依赖
- 支持事件优先级、拦截、钩子等高级控制机制

### 2. **模块化设计**
- 每个功能都是一个 `Module` 子类，独立开发、独立加载
- 支持模块依赖管理、拓扑排序加载、动态卸载
- 模块间可通过 `context.mod` 安全访问，实现有限通信

### 3. **统一配置管理**
- 所有配置集中管理于 `config.json`
- 支持 Web 界面实时修改、批量更新
- 配置项可按模块分组，类型安全，带默认值

### 4. **内置持久化存储**
- 提供 `storage` 模块，自动序列化/反序列化 Python 对象
- 支持列表、字典、集合、自定义对象等类型的透明持久化
- 模块无需关心存储细节，只需声明需要持久化的数据

---

## ✨ 主要功能特性

| 功能模块 | 说明 |
|----------|------|
| **随机回复** | 根据概率随机发送预设回复 |
| **关键词回复** | 匹配关键词后触发特定回复 |
| **特定用户回复** | 对指定用户进行定制化回复 |
| **表情回复** | 自动为指定用户或消息贴表情 |
| **复读检测** | 检测连续相同消息并概率复读 |
| **随机艾特** | 概率对消息发送者进行空回复艾特 |
| **戳一戳** | 随机对消息发送者发起戳一戳 |
| **定时播报** | 在指定时间发送预设消息 |
| **LLM 智能回复** | 接入 OpenAI 兼容的 LLM 进行上下文感知回复 |
| **多模态视觉理解** | 支持图片内容识别与描述 |
| **跟随贴表情** | 检测群内表情行为并自动跟贴 |
| **表情达标回复** | 检测表情数量达标后触发回复 |
| **心流回复** | 基于小模型动态决策是否回复 |
| **消息归档与向量检索** | 自动归档消息并支持语义检索 |
| **消息格式化** | 支持高级消息展示（如昵称替换、图片摘要） |
| **Web 配置管理** | 通过 Flask Web 界面管理配置、查看模块状态 |

---

## 🛠️ 设计优势

### ✅ **高可扩展性**
- 新功能只需继承 `Module`，注册事件监听器即可
- 无需修改核心代码，真正实现“插件化”

### ✅ **配置驱动**
- 所有行为均可通过配置文件调整
- 支持实时更新，无需重启服务

### ✅ **松耦合架构**
- 模块间通过事件通信，无硬编码依赖
- 支持模块热加载、卸载，系统更稳定

### ✅ **内置工具链**
- 提供 `logger`、`storage`、`config` 等基础服务模块
- 开发者可专注于业务逻辑，无需重复造轮子

### ✅ **现代化 AI 集成**
- 原生支持 LLM、视觉模型、向量检索等 AI 能力
- 支持工具调用（Function Calling），可扩展性强

### ✅ **优雅的异步处理**
- 基于 `asyncio` 实现高效异步消息处理
- 支持延迟回复、超时控制等高级交互

---

## 🧩 模块依赖图（示例）

```
config → storage → archive → embedding
  ↓        ↓          ↓         ↓
llm ←─ vision_llm ← message_formatter
  ↓        ↓
heartflow   ↓
  ↓        ↓
各种回复模块（RandomReply, KeywordReply, ...）
```

---

## 🚀 部署与使用

### 环境要求
- Python 3.8+
- Napcat（WebSocket 服务端）
- 依赖包见 `requirements.txt`

### 快速启动
1. 配置 `config.json`（参考示例文件）
2. 运行 `python autowater.py`
3. 访问 `http://127.0.0.1:5000` 管理配置

### 开发新模块
1. 在 `module_list/` 下创建新文件
2. 继承 `Module` 类，实现 `register` 方法
3. 通过 `message_handler.register_listener` 注册事件监听
4. 通过 `config.register_config` 注册配置项

---

## 👥 贡献者


| 姓名 | 贡献 |
|------|------|
| Hikari | 实现特定用户回复功能 |
| Uint | 提出架构重构建议，参与代码优化，完成10000+行代码的主要工作 |
| Catismfans | 实现表情追踪与自动回复功能 |
| M42 | 参与模块拆分、日志系统优化，提出了项目的设想 |

---

## 📄 许可证

本项目采用 MIT 许可证。详见 `LICENSE` 文件。

---

## 🌟 设计哲学

> “好的架构不是一次性构建出来的，而是通过不断解耦、抽象、模块化演进而来。”

AutoWater 不仅仅是一个“水群机器人”，它更是一个**实验性的模块化异步事件驱动框架**，展示了如何在复杂交互系统中实现高内聚、低耦合、可扩展的软件设计。

我们相信，通过清晰的事件流、统一的配置管理、透明的持久化机制，以及友好的开发接口，可以让机器人开发变得像搭积木一样简单而富有乐趣。

---

## 📬 反馈与协作

欢迎提交 Issue、Pull Request，或通过项目讨论区交流。我们尤其欢迎对架构设计、模块扩展、性能优化等方面的建议与贡献。

**让水群，从此变得优雅。**